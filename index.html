<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>أصابع الفرعون — مجلة خفيفة مع أداة كتابة</title>
  <meta name="description" content="أصابع الفرعون: موقع مقالات خفيف وجميل، مع أداة لكتابة ونشر مقالات منظمة مع الصور.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #0e0f13;
      --card: #171923;
      --muted: #8b90a3;
      --text: #e9ecf1;
      --brand: #e0b15a;
      --accent: #5ac8e0;
      --radius: 18px;
      --shadow: 0 8px 24px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:"Cairo",system-ui,Segoe UI,Arial;}
    a{color:var(--brand);text-decoration:none}
    img{max-width:100%;display:block}
    .container{max-width:1100px;margin:0 auto;padding:20px}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(14,15,19,.9),rgba(14,15,19,.6));backdrop-filter:saturate(180%) blur(10px);border-bottom:1px solid rgba(255,255,255,.06);}
    .nav{display:flex;align-items:center;gap:16px;justify-content:space-between}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.5px}
    .logo-badge{width:36px;height:36px;border-radius:12px;background:conic-gradient(from 120deg,var(--brand),#b27b2b,var(--brand));display:grid;place-items:center;box-shadow:var(--shadow)}
    .logo-badge span{font-weight:800}
    .nav a.btn{padding:10px 14px;border:1px solid rgba(255,255,255,.08);border-radius:12px;cursor:pointer}
    .hero{display:grid;grid-template-columns:1.1fr .9fr;gap:20px;align-items:stretch;margin:24px 0}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .p{padding:20px}
    .hero .title{font-size:34px;line-height:1.25;margin:0 0 10px}
    .hero .subtitle{color:var(--muted);margin:0 0 16px}
    .grid{display:grid;grid-template-columns:2.2fr 1fr;gap:20px}
    .posts{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    .post{overflow:hidden}
    .post .thumb{aspect-ratio:16/9;background:#101219;border-bottom:1px solid rgba(255,255,255,.06)}
    .post .meta{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:12px;margin-top:6px}
    .post h3{margin:10px 0 6px;font-size:18px}
    .sidebar .widget{padding:16px;border-radius:var(--radius);background:var(--card);border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow)}
    .ad-slot{display:grid;place-items:center;aspect-ratio: 1.2/1;background:#0f111a;border:1px dashed rgba(255,255,255,.15);border-radius:14px}
    .ad-slot small{color:var(--muted)}
    dialog#editor{width:min(980px,96vw);border:0;border-radius:22px;padding:0;background:var(--bg);color:var(--text);box-shadow:0 40px 120px rgba(0,0,0,.6)}
    .ed-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08);background:#0c0d12;border-top-left-radius:22px;border-top-right-radius:22px}
    .ed-title{font-weight:700}
    .ed-body{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;padding:16px}
    .toolbar{display:flex;flex-wrap:wrap;gap:10px;padding:10px;background:#0f1117;border-radius:14px;border:1px solid rgba(255,255,255,.06)}
    .tool-btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08);background:#141724;cursor:pointer}
    .tool-btn:active{transform:translateY(1px)}
    .ed-left{display:flex;flex-direction:column;gap:10px}
    #editorArea{min-height:320px;padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:#121424}
    #editorArea:empty::before{content:"ابدأ الكتابة هنا…";color:var(--muted)}
    .ed-right{display:flex;flex-direction:column;gap:10px}
    input, textarea, select{width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#101322;color:var(--text)}
    label{font-size:13px;color:var(--muted)}
    .actions{display:flex;gap:10px;justify-content:flex-end;padding:10px 16px;border-top:1px solid rgba(255,255,255,.08)}
    .primary{background:var(--brand);color:#000;border:0}
    .ghost{background:transparent;color:var(--text)}
    footer{margin:30px 0;color:var(--muted);text-align:center}
    @media (max-width: 900px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .posts{grid-template-columns:1fr}
      .ed-body{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="logo">
        <div class="logo-badge" aria-hidden="true"><span>𓂀</span></div>
        <div>
          <div style="font-size:20px">أصابع الفرعون</div>
          <small style="color:var(--muted)">مجلة خفيفة — أنشئ مقالًا بسهولة</small>
        </div>
      </div>
      <nav style="display:flex;align-items:center;gap:10px">
        <a class="btn" id="openEditorBtn">✍️ أداة كتابة</a>
        <a class="btn" href="#posts">📚 المقالات</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <article class="card">
        <div class="p">
          <h1 class="title">أهلاً بك في «أصابع الفرعون»</h1>
          <p class="subtitle">موقع مقالات بسيط، يمكنك كتابة المقالات مباشرة ونشرها لكل الزوار.</p>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <button class="tool-btn" id="openEditorBtn2">ابدأ كتابة مقال جديد</button>
          </div>
        </div>
      </article>
      <aside class="card">
        <div class="p">
          <h3 style="margin:0 0 12px">مساحة إعلان</h3>
          <div class="ad-slot"><small>موضع إعلان</small></div>
        </div>
      </aside>
    </section>

    <section class="grid" id="posts">
      <div>
        <h2 style="margin:0 0 12px">أحدث المقالات</h2>
        <div class="posts" id="postsWrap">
          <!-- سيتم حقنه آليًا -->
        </div>
      </div>
      <aside class="sidebar" aria-label="شريط جانبي">
        <div class="widget">
          <h3 style="margin-top:0">حول الموقع</h3>
          <p style="margin:0;color:var(--muted)">قالب مفتوح المصدر، المقالات تخزن في قاعدة بيانات Neon.</p>
        </div>
      </aside>
    </section>

    <footer>
      <div>© <span id="year"></span> أصابع الفرعون — جميع الحقوق محفوظة</div>
    </footer>
  </main>

  <!-- نافذة أداة الكتابة -->
  <dialog id="editor">
    <div class="ed-header">
      <div class="ed-title">✍️ أداة كتابة مقال</div>
      <button class="tool-btn ghost" id="closeEditor">إغلاق</button>
    </div>
    <div class="ed-body">
      <div class="ed-left">
        <div class="toolbar">
          <button class="tool-btn" data-cmd="bold">عريض</button>
          <button class="tool-btn" data-cmd="italic">مائل</button>
          <button class="tool-btn" data-cmd="formatBlock" data-value="h2">عنوان فرعي</button>
          <button class="tool-btn" data-cmd="insertUnorderedList">قائمة نقطية</button>
          <button class="tool-btn" id="insertImageBtn">إدراج صورة</button>
          <button class="tool-btn" id="insertDividerBtn">فاصل</button>
          <button class="tool-btn" id="clearBtn">مسح</button>
        </div>
        <div id="editorArea" contenteditable="true"></div>
      </div>
      <div class="ed-right">
        <div>
          <label>عنوان المقال</label>
          <input type="text" id="postTitle" placeholder="اكتب عنوانًا جذابًا">
        </div>
        <div>
          <label>رابط صورة الغلاف (اختياري)</label>
          <input type="url" id="coverUrl" placeholder="https://...">
        </div>
        <div>
          <label>وصف قصير</label>
          <textarea id="postDesc" rows="3" placeholder="ملخص قصير عن المقال"></textarea>
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="tool-btn ghost" id="previewBtn">معاينة</button>
      <button class="tool-btn primary" id="publishBtn">نشر المقال</button>
    </div>
  </dialog>

  <template id="postCardTpl">
    <article class="post card">
      <div class="thumb"></div>
      <div class="p">
        <div class="meta"><span class="date"></span></div>
        <h3 class="title"></h3>
        <p class="excerpt" style="color:var(--muted)"></p>
      </div>
    </article>
  </template>

  <script>
    const $$ = s=>document.querySelector(s);
    const $$$ = s=>document.querySelectorAll(s);
    const apiAdd = '/.netlify/functions/addPost';
    const apiGet = '/.netlify/functions/getPosts';

    document.getElementById('openEditorBtn').onclick = ()=>$$('#editor').showModal();
    document.getElementById('openEditorBtn2').onclick = ()=>$$('#editor').showModal();
    document.getElementById('closeEditor').onclick = ()=>$$('#editor').close();
    document.getElementById('year').textContent = new Date().getFullYear();

    // أدوات التنسيق
    $$('.toolbar').addEventListener('click', e=>{
      const btn = e.target.closest('.tool-btn');
      if(!btn) return;
      const cmd = btn.dataset.cmd;
      if(!cmd) return;
      const value = btn.dataset.value || null;
      document.execCommand(cmd,false,value);
      $$('#editorArea').focus();
    });

    $$('#insertImageBtn').addEventListener('click', ()=>{
      const url = prompt('رابط الصورة:');
      if(url) document.execCommand('insertImage',false,url);
    });

    $$('#insertDividerBtn').addEventListener('click', ()=>{
      const hr = document.createElement('hr');
      hr.style.border='0'; hr.style.borderTop='1px solid rgba(255,255,255,.1)'; hr.style.margin='16px 0';
      const sel = window.getSelection();
      if(sel.rangeCount) sel.getRangeAt(0).insertNode(hr);
    });

    $$('#clearBtn').addEventListener('click', ()=>{
      if(confirm('مسح المحتوى؟')) $$('#editorArea').innerHTML='';
    });

    function collectEditor(){
      return {
        title: $$('#postTitle').value.trim(),
        content: $$('#editorArea').innerHTML.trim(),
        cover: $$('#coverUrl').value.trim(),
        desc: $$('#postDesc').value.trim(),
        author: "زائر"
      };
    }

    async function publishPost(){
      const data = collectEditor();
      if(!data.title || !data.content){
        alert('يرجى إدخال عنوان ومحتوى.');
        return;
      }
      try{
        const res = await fetch(apiAdd,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        const json = await res.json();
        if(json.success){
          alert('تم نشر المقال بنجاح!');
          $$('#editor').close();
          $$('#editorArea').innerHTML='';
          $$('#postTitle').value='';
          $$('#coverUrl').value='';
          $$('#postDesc').value='';
          loadPosts();
        } else { alert('خطأ: '+json.error) }
      }catch(e){alert('تعذر الاتصال بالخادم')}
    }

    $$('#publishBtn').addEventListener('click', publishPost);

    async function loadPosts(){
      try{
        const res = await fetch(apiGet);
        const json = await res.json();
        const wrap = $$('#postsWrap');
        wrap.innerHTML='';
        if(!json.success || !json.posts.length){
          wrap.innerHTML='<div class="card p" style="grid-column:1/-1;color:var(--muted)">لا توجد مقالات بعد.</div>';
          return;
        }
        json.posts.forEach(p=>{
          const tpl = document.getElementById('postCardTpl').content.cloneNode(true);
          tpl.querySelector('.thumb').style.backgroundImage = p.cover?`url(${p.cover})`:'';
          tpl.querySelector('.thumb').style.backgroundSize='cover';
          tpl.querySelector('.thumb').style.backgroundPosition='center';
          tpl.querySelector('.date').textContent = new Date(p.created_at).toLocaleDateString('ar-EG',{year:'numeric',month:'long',day:'numeric'});
          tpl.querySelector('.title').textContent = p.title;
          tpl.querySelector('.excerpt').textContent = p.desc || '';
          wrap.appendChild(tpl);
        });
      }catch(e){
        console.error(e);
      }
    }

    loadPosts();
  </script>
</body>
</html>
